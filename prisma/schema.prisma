generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id                  String               @id @default(cuid())
  name                String
  plan                String               @default("free")
  apiKey              String               @unique @default(cuid())
  hmacSecret          String?
  settings            Json?
  storageLimitMB      Int? // הגבלת שטח אחסון במגה בייט - null = אין הגבלה
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  auditLogs           AuditLog[]
  calendarEvents      CalendarEvent[]
  emailTemplates      EmailTemplate[]
  files               File[]
  integrations        Integration[]
  invitations         Invitation[]
  notifications       Notification[]
  shops               Shop[]
  subscription        Subscription?
  users               User[]
  plugins             Plugin[]
  pluginSubscriptions PluginSubscription[]

  @@map("companies")
}

model User {
  id              String           @id @default(cuid())
  email           String           @unique
  name            String
  password        String
  role            UserRole         @default(USER)
  companyId       String
  avatar          String?
  settings        Json?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  phone           String?
  auditLogs       AuditLog[]
  blogPosts       BlogPost[]
  coupons         Coupon[]
  sentInvitations Invitation[]     @relation("Inviter")
  invitation      Invitation?      @relation("InvitedUser")
  notifications   Notification[]
  permissions     UserPermission[]
  reviewReplies   ReviewReply[]
  productAnswers  ProductAnswer[]
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([email])
  @@map("users")
}

model File {
  id         String   @id @default(cuid())
  companyId  String
  entityType String
  entityId   String
  path       String
  name       String
  size       Int
  mimeType   String?
  uploadedBy String?
  createdAt  DateTime @default(now())
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([entityType, entityId])
  @@map("files")
}

model AuditLog {
  id         String   @id @default(cuid())
  companyId  String
  userId     String?
  action     String
  entityType String
  entityId   String?
  diff       Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user       User?    @relation(fields: [userId], references: [id])

  @@index([companyId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model EmailTemplate {
  id        String   @id @default(cuid())
  companyId String
  name      String
  subject   String
  body      String
  variables String[] @default([])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("email_templates")
}

model Notification {
  id         String   @id @default(cuid())
  companyId  String
  userId     String
  type       String
  title      String
  message    String
  entityType String?
  entityId   String?
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

model Integration {
  id         String          @id @default(cuid())
  companyId  String
  type       IntegrationType
  name       String
  apiKey     String?
  apiSecret  String?
  config     Json?
  isActive   Boolean         @default(true)
  lastSyncAt DateTime?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  company    Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, type])
  @@index([companyId])
  @@map("integrations")
}

model CalendarEvent {
  id          String   @id @default(cuid())
  companyId   String
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  location    String?
  attendees   String[] @default([])
  isAllDay    Boolean  @default(false)
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([startTime])
  @@map("calendar_events")
}

model Invitation {
  id          String           @id @default(cuid())
  companyId   String
  email       String
  name        String?
  token       String           @unique
  invitedBy   String
  permissions Json
  status      InvitationStatus @default(PENDING)
  acceptedAt  DateTime?
  userId      String?          @unique
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  expiresAt   DateTime
  role        UserRole         @default(USER)
  company     Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  inviter     User             @relation("Inviter", fields: [invitedBy], references: [id])
  user        User?            @relation("InvitedUser", fields: [userId], references: [id])

  @@index([companyId])
  @@index([email])
  @@index([token])
  @@index([status])
  @@map("invitations")
}

model UserPermission {
  id         String   @id @default(cuid())
  userId     String
  permission String
  allowed    Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permission])
  @@index([userId])
  @@map("user_permissions")
}

model Shop {
  id                       String                  @id @default(cuid())
  companyId                String
  name                     String
  slug                     String                  @unique
  description              String?
  logo                     String?
  favicon                  String?
  category                 String?
  email                    String?
  phone                    String?
  address                  String?
  workingHours             Json?
  currency                 String                  @default("ILS")
  taxEnabled               Boolean                 @default(true)
  taxRate                  Float                   @default(18)
  pricesIncludeTax         Boolean                 @default(true)
  theme                    String                  @default("default")
  themeSettings            Json?
  domain                   String?
  isPublished              Boolean                 @default(false)
  settings                 Json?
  customerDiscountSettings Json?
  createdAt                DateTime                @default(now())
  updatedAt                DateTime                @updatedAt
  automations              Automation[]
  blogs                    Blog[]
  Bundle                   Bundle[]
  Cart                     Cart[]
  categories               Category[]
  collections              Collection[]
  coupons                  Coupon[]
  customers                Customer[]
  contacts                 Contact[]
  contactCategories        ContactCategory[]
  Discount                 Discount[]
  GiftCard                 GiftCard[]
  Navigation               Navigation[]
  orders                   Order[]
  pages                    Page[]
  products                 Product[]
  Return                   Return[]
  Review                   Review[]
  reviewReplies            ReviewReply[]
  productQuestions         ProductQuestion[]
  productAnswers           ProductAnswer[]
  reviewTagDefinitions     ReviewTagDefinition[]
  events                   ShopEvent[]
  company                  Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  StoreCredit              StoreCredit[]
  trackingPixels           TrackingPixel[]
  trafficSources           TrafficSource[]
  webhooks                 Webhook[]
  wishlistItems            WishlistItem[]
  customFieldDefinitions   CustomFieldDefinition[]
  productAddons            ProductAddon[]
  plugins                  Plugin[]
  sizeCharts               SizeChart[]
  productPageTemplates     ProductPageTemplate[]
  otpTokens                OtpToken[]
  waitlist                 Waitlist[]
  popups                   Popup[]

  @@index([companyId])
  @@index([slug])
  @@map("shops")
}

model Product {
  id                   String               @id @default(cuid())
  shopId               String
  name                 String
  slug                 String
  description          String?
  sku                  String?
  price                Float
  comparePrice         Float?
  cost                 Float?
  taxEnabled           Boolean              @default(true)
  inventoryEnabled     Boolean              @default(true)
  inventoryQty         Int                  @default(0)
  lowStockAlert        Int?
  trackInventory       Boolean              @default(true)
  sellWhenSoldOut      Boolean              @default(false) // המשך מכירה כשאין במלאי
  priceByWeight        Boolean              @default(false) // זהו מוצר נמכר לפי משקל (ק"ג)
  showPricePer100ml    Boolean              @default(false) // האם להציג מחיר ל-100 מ״ל
  pricePer100ml        Float? // מחיר ל-100 מ״ל (אם showPricePer100ml = true)
  isGiftCard           Boolean              @default(false) // האם זה מוצר gift card
  exclusiveToTier      String[]             @default([]) // רמות מועדון פרימיום שיש להן גישה למוצר זה
  earlyAccessStartDate DateTime?            // תאריך התחלה מוקדם למבצע (ללקוחות עם early access)
  weight               Float?
  dimensions           Json?
  status               ProductStatus        @default(DRAFT)
  scheduledPublishDate DateTime? // תאריך ושעה לפרסום אוטומטי
  notifyOnPublish      Boolean              @default(false) // האם לשלוח מייל כשהמוצר מתפרסם
  images               String[]
  video                String?
  minQuantity          Int?
  maxQuantity          Int?
  availability         ProductAvailability  @default(IN_STOCK)
  availableDate        DateTime?
  seoTitle             String?
  seoDescription       String?
  customFields         Json?
  badges               Json? // מדבקות למוצר (טקסט, צבע, מיקום)
  pageTemplateId       String? // תבנית עמוד מוצר
  defaultVariantId     String? // ווריאנט ברירת מחדל
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  bundles              BundleProduct[]
  orderItems           OrderItem[]
  categories           ProductCategory[]
  collections          ProductCollection[]
  options              ProductOption[]
  tags                 ProductTag[]
  variants             ProductVariant[]
  shop                 Shop                 @relation(fields: [shopId], references: [id], onDelete: Cascade)
  reviews              Review[]
  productQuestions     ProductQuestion[]
  wishlistItems        WishlistItem[]
  customFieldValues    CustomFieldValue[]
  pageTemplate         ProductPageTemplate? @relation(fields: [pageTemplateId], references: [id], onDelete: SetNull)
  waitlist             Waitlist[]

  @@index([shopId])
  @@index([slug])
  @@index([status])
  @@map("products")
}

model ProductVariant {
  id            String         @id @default(cuid())
  productId     String
  name          String
  sku           String?
  barcode       String?
  price         Float?
  comparePrice  Float?
  cost          Float?
  inventoryQty  Int            @default(0)
  weight        Float?
  image         String?
  option1       String?
  option1Value  String?
  option2       String?
  option2Value  String?
  option3       String?
  option3Value  String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  orderItems    OrderItem[]
  product       Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  wishlistItems WishlistItem[]
  waitlist      Waitlist[]

  @@index([productId])
  @@map("product_variants")
}

model ProductOption {
  id        String   @id @default(cuid())
  productId String
  name      String
  type      String   @default("button")
  values    Json
  position  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_options")
}

model Category {
  id          String            @id @default(cuid())
  shopId      String
  name        String
  slug        String
  description String?
  parentId    String?
  image       String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  parent      Category?         @relation("CategoryParent", fields: [parentId], references: [id])
  children    Category[]        @relation("CategoryParent")
  shop        Shop              @relation(fields: [shopId], references: [id], onDelete: Cascade)
  products    ProductCategory[]

  @@index([shopId])
  @@index([slug])
  @@map("categories")
}

model ProductCategory {
  id         String   @id @default(cuid())
  productId  String
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, categoryId])
  @@map("product_categories")
}

model ProductTag {
  id        String  @id @default(cuid())
  productId String
  name      String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, name])
  @@map("product_tags")
}

model SizeChart {
  id          String   @id @default(cuid())
  shopId      String
  name        String
  content     String? // HTML content from rich text editor
  imageUrl    String? // Image URL if using image instead of content
  displayType String   @default("global") // "global", "categories", "products"
  categoryIds String[] @default([]) // Array of category IDs if displayType is "categories"
  productIds  String[] @default([]) // Array of product IDs if displayType is "products"
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([displayType])
  @@index([isActive])
  @@map("size_charts")
}

model Collection {
  id             String              @id @default(cuid())
  shopId         String
  name           String
  slug           String
  description    String?
  image          String?
  type           CollectionType      @default(MANUAL)
  isPublished    Boolean             @default(true)
  rules          Json?
  seoTitle       String?
  seoDescription String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  shop           Shop                @relation(fields: [shopId], references: [id], onDelete: Cascade)
  products       ProductCollection[]

  @@index([shopId])
  @@index([slug])
  @@index([isPublished])
  @@map("collections")
}

model ProductCollection {
  id           String     @id @default(cuid())
  productId    String
  collectionId String
  position     Int        @default(0)
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  product      Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, collectionId])
  @@map("product_collections")
}

model Customer {
  id                     String            @id @default(cuid())
  shopId                 String
  email                  String
  password               String?
  firstName              String?
  lastName               String?
  phone                  String?
  dateOfBirth            DateTime?
  addresses              Json?
  preferredPaymentMethod String? // שיטת תשלום מועדפת: credit_card, bank_transfer, cash
  totalSpent             Float             @default(0)
  orderCount             Int               @default(0)
  tier                   CustomerTier      @default(REGULAR)
  premiumClubTier         String?           // רמת מועדון פרימיום: silver, gold, platinum
  tags                   String[]
  notes                  String?
  isSubscribed           Boolean           @default(false)
  emailVerified          Boolean           @default(false)
  lastLoginAt            DateTime?
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  blogComments           BlogComment[]
  carts                  Cart[]
  shop                   Shop              @relation(fields: [shopId], references: [id], onDelete: Cascade)
  orders                 Order[]
  Return                 Return[]
  reviews                Review[]
  reviewReplies          ReviewReply[]
  productQuestions       ProductQuestion[]
  productAnswers         ProductAnswer[]
  storeCredits           StoreCredit[]
  wishlistItems          WishlistItem[]
  waitlist               Waitlist[]
  contact                Contact?

  @@index([shopId])
  @@index([email])
  @@map("customers")
}

model Order {
  id                String            @id @default(cuid())
  shopId            String
  orderNumber       String
  customerId        String?
  status            OrderStatus       @default(PENDING)
  paymentStatus     PaymentStatus     @default(PENDING)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)
  customerName      String
  customerEmail     String
  customerPhone     String?
  shippingAddress   Json
  billingAddress    Json?
  subtotal          Float
  shipping          Float
  tax               Float
  discount          Float             @default(0)
  total             Float
  paymentMethod     String?
  transactionId     String?
  paidAt            DateTime?
  shippingMethod    String?
  trackingNumber    String?
  shippedAt         DateTime?
  deliveredAt       DateTime?
  notes             String?
  couponCode        String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  customFields      Json?
  paymentLink       String?
  trafficSourceId   String? // מקור התנועה שהביא את ההזמנה

  // מידע על משלוח לחברת משלוחים
  shippingProvider        String? // שם החברה (focus, dhl, וכו')
  shippingProviderId      String? // ID של האינטגרציה
  shippingTrackingNumber  String? // מספר מעקב מהחברה
  shippingLabelUrl        String? // URL לתווית משלוח (אם שמור ב-S3)
  shippingLabelS3Key      String? // S3 key לתווית (אם שמור ב-S3)
  shippingSentAt          DateTime? // מתי נשלח לחברת המשלוחים
  shippingStatus          String? // סטטוס המשלוח (pending, sent, in_transit, delivered, cancelled, failed)
  shippingStatusUpdatedAt DateTime? // מתי עודכן הסטטוס לאחרונה
  shippingData            Json? // מידע נוסף מהחברה (shipment_id, response, וכו')
  shippingError           String? // שגיאה אחרונה (אם נכשל)
  shippingRetryCount      Int       @default(0) // מספר ניסיונות שליחה
  shippingLastRetryAt     DateTime? // מתי ניסו לשלוח בפעם האחרונה

  giftCardTransactions    GiftCardTransaction[]
  items                   OrderItem[]
  customer                Customer?                @relation(fields: [customerId], references: [id])
  shop                    Shop                     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  returns                 Return[]
  storeCreditTransactions StoreCreditTransaction[]
  shippingLogs            ShippingLog[]
  verifiedReviews         Review[]
  trafficSource           TrafficSource? @relation(fields: [trafficSourceId], references: [id])

  @@unique([shopId, orderNumber])
  @@index([shopId])
  @@index([orderNumber])
  @@index([customerId])
  @@index([status])
  @@index([shippingProvider])
  @@index([shippingStatus])
  @@index([trafficSourceId])
  @@map("orders")
}

model OrderItem {
  id           String          @id @default(cuid())
  orderId      String
  productId    String?
  variantId    String?
  name         String
  sku          String?
  quantity     Int
  price        Float
  total        Float
  addons       Json? // Add-ons that were selected: [{ addonId, valueId, label, price, quantity }]
  giftCardData Json? // נתוני gift card אם זה מוצר gift card: { recipientName, recipientEmail, recipientPhone, message, senderName }
  createdAt    DateTime        @default(now())
  order        Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product      Product?        @relation(fields: [productId], references: [id])
  variant      ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

model ShippingLog {
  id           String   @id @default(cuid())
  orderId      String
  provider     String // focus, dhl, וכו'
  action       String // create, cancel, get_label, get_status
  status       String // success, failed, pending
  requestData  Json? // מה שנשלח
  responseData Json? // מה שהתקבל
  error        String? // שגיאה (אם נכשל)
  durationMs   Int? // כמה זמן לקח
  retryAttempt Int      @default(0) // מספר ניסיון
  createdAt    DateTime @default(now())
  order        Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([provider])
  @@index([status])
  @@index([createdAt])
  @@map("shipping_logs")
}

model Cart {
  id          String    @id @default(cuid())
  shopId      String
  sessionId   String?
  customerId  String?
  items       Json
  couponCode  String?
  expiresAt   DateTime
  abandonedAt DateTime?
  recoveredAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  customer    Customer? @relation(fields: [customerId], references: [id])
  shop        Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([sessionId])
  @@index([customerId])
  @@index([expiresAt])
  @@index([abandonedAt])
  @@map("carts")
}

model Coupon {
  id                      String         @id @default(cuid())
  shopId                  String
  code                    String         @unique
  type                    DiscountType
  value                   Float
  buyQuantity             Int?
  getQuantity             Int?
  getDiscount             Float?
  payQuantity             Int? // עבור BUY_X_PAY_Y: כמה פריטים משלמים עליהם
  payAmount               Float? // עבור BUY_X_PAY_Y: סכום קבוע לשלם (לדוגמה: 55₪ על 2 פריטים)
  nthItem                 Int?
  volumeRules             Json?
  minOrder                Float?
  maxDiscount             Float?
  maxUses                 Int?
  usesPerCustomer         Int?           @default(1)
  usedCount               Int            @default(0)
  startDate               DateTime?
  endDate                 DateTime?
  isActive                Boolean        @default(true)
  applicableProducts      String[]
  applicableCategories    String[]
  applicableCustomers     String[]
  canCombine              Boolean        @default(false)
  influencerId            String?
  // שדות להפעלת מתנה אוטומטית
  giftProductId           String?
  giftVariantId           String?
  giftCondition           GiftCondition?
  giftConditionProductId  String?
  giftConditionAmount     Float?
  // שדות להפעלת הנחת לקוח רשום
  enableCustomerDiscount  Boolean        @default(false)
  customerDiscountPercent Float? // אחוז הנחה ללקוח רשום (לדוגמה: 5)
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @default(now())
  influencer              User?          @relation(fields: [influencerId], references: [id])
  shop                    Shop           @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([code])
  @@index([influencerId])
  @@map("coupons")
}

model Discount {
  id                     String                 @id @default(cuid())
  shopId                 String
  title                  String
  description            String?
  type                   DiscountType
  value                  Float
  buyQuantity            Int?
  getQuantity            Int?
  getDiscount            Float?
  nthItem                Int?
  volumeRules            Json?
  target                 DiscountTarget         @default(ALL_PRODUCTS)
  customerTarget         DiscountCustomerTarget @default(ALL_CUSTOMERS)
  applicableProducts     String[]               @default([])
  applicableCategories   String[]               @default([])
  applicableCollections  String[]               @default([])
  excludedProducts       String[]               @default([])
  excludedCategories     String[]               @default([])
  excludedCollections    String[]               @default([])
  customerTiers          String[]               @default([])
  specificCustomers      String[]               @default([])
  minOrderAmount         Float?
  maxDiscount            Float?
  maxUses                Int?
  usesPerCustomer        Int?                   @default(1)
  usedCount              Int                    @default(0)
  startDate              DateTime?
  endDate                DateTime?
  isActive               Boolean                @default(true)
  isAutomatic            Boolean                @default(false)
  priority               Int                    @default(0)
  canCombine             Boolean                @default(false)
  giftProductId          String?
  giftCondition          GiftCondition?
  giftConditionProductId String?
  giftConditionAmount    Float?
  giftVariantId          String?
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  shop                   Shop                   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([isActive])
  @@index([isAutomatic])
  @@index([startDate])
  @@index([endDate])
  @@map("discounts")
}

model GiftCard {
  id             String                @id @default(cuid())
  shopId         String
  code           String                @unique
  amount         Float
  balance        Float                 @default(0)
  recipientEmail String
  recipientName  String?
  senderName     String?
  message        String?
  expiresAt      DateTime?
  isActive       Boolean               @default(true)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  transactions   GiftCardTransaction[]
  shop           Shop                  @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([code])
  @@map("gift_cards")
}

model GiftCardTransaction {
  id         String          @id @default(cuid())
  giftCardId String
  orderId    String?
  amount     Float
  type       TransactionType
  createdAt  DateTime        @default(now())
  giftCard   GiftCard        @relation(fields: [giftCardId], references: [id], onDelete: Cascade)
  order      Order?          @relation(fields: [orderId], references: [id])

  @@index([giftCardId])
  @@index([orderId])
  @@map("gift_card_transactions")
}

model StoreCredit {
  id           String                   @id @default(cuid())
  shopId       String
  customerId   String
  amount       Float
  balance      Float                    @default(0)
  reason       String?
  expiresAt    DateTime?
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt
  transactions StoreCreditTransaction[]
  customer     Customer                 @relation(fields: [customerId], references: [id], onDelete: Cascade)
  shop         Shop                     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([customerId])
  @@map("store_credits")
}

model StoreCreditTransaction {
  id            String          @id @default(cuid())
  storeCreditId String
  orderId       String?
  amount        Float
  type          TransactionType
  createdAt     DateTime        @default(now())
  order         Order?          @relation(fields: [orderId], references: [id])
  storeCredit   StoreCredit     @relation(fields: [storeCreditId], references: [id], onDelete: Cascade)

  @@index([storeCreditId])
  @@index([orderId])
  @@map("store_credit_transactions")
}

model Review {
  id              String        @id @default(cuid())
  shopId          String
  productId       String
  customerId      String?
  rating          Int
  title           String?
  comment         String?
  images          String[]
  videos          String[]      @default([])
  tags            String[]      @default([]) // תגיות כמו "איכות", "משלוח", "שירות"
  isApproved      Boolean       @default(false)
  isVerified      Boolean       @default(false)
  verifiedOrderId String? // ID של ההזמנה שמאמתת את הרכישה
  helpfulCount    Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  customer        Customer?     @relation(fields: [customerId], references: [id])
  product         Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  shop            Shop          @relation(fields: [shopId], references: [id], onDelete: Cascade)
  replies         ReviewReply[] @relation("ReviewReplies")
  order           Order?        @relation(fields: [verifiedOrderId], references: [id])

  @@index([shopId])
  @@index([productId])
  @@index([isApproved])
  @@index([isVerified])
  @@map("reviews")
}

// תגובות לביקורות
model ReviewReply {
  id          String    @id @default(cuid())
  reviewId    String
  shopId      String
  userId      String? // ID של בעל החנות או לקוח
  customerId  String? // אם זה לקוח
  comment     String
  isShopOwner Boolean   @default(false) // האם זה בעל החנות
  isApproved  Boolean   @default(true) // תגובות של בעל חנות מאושרות אוטומטית
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  review      Review    @relation("ReviewReplies", fields: [reviewId], references: [id], onDelete: Cascade)
  shop        Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  customer    Customer? @relation(fields: [customerId], references: [id])
  user        User?     @relation(fields: [userId], references: [id])

  @@index([reviewId])
  @@index([shopId])
  @@map("review_replies")
}

// שאלות ותשובות על מוצרים
model ProductQuestion {
  id           String          @id @default(cuid())
  shopId       String
  productId    String
  customerId   String?
  question     String
  isApproved   Boolean         @default(false)
  helpfulCount Int             @default(0)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  product      Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  shop         Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)
  customer     Customer?       @relation(fields: [customerId], references: [id])
  answers      ProductAnswer[]

  @@index([shopId])
  @@index([productId])
  @@index([isApproved])
  @@map("product_questions")
}

model ProductAnswer {
  id           String          @id @default(cuid())
  questionId   String
  shopId       String
  userId       String? // ID של בעל החנות או לקוח
  customerId   String? // אם זה לקוח
  answer       String
  isShopOwner  Boolean         @default(false) // האם זה בעל החנות
  isApproved   Boolean         @default(true) // תשובות של בעל חנות מאושרות אוטומטית
  helpfulCount Int             @default(0)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  question     ProductQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  shop         Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)
  customer     Customer?       @relation(fields: [customerId], references: [id])
  user         User?           @relation(fields: [userId], references: [id])

  @@index([questionId])
  @@index([shopId])
  @@map("product_answers")
}

// הגדרות תגיות לביקורות (ניתן להגדיר בחנות)
model ReviewTagDefinition {
  id        String   @id @default(cuid())
  shopId    String
  name      String // שם התגית בעברית
  nameEn    String? // שם התגית באנגלית
  icon      String? // אייקון (lucide icon name)
  color     String? // צבע התגית
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, name])
  @@index([shopId])
  @@map("review_tag_definitions")
}

model Return {
  id           String       @id @default(cuid())
  shopId       String
  orderId      String
  customerId   String
  status       ReturnStatus @default(PENDING)
  reason       String
  items        Json
  refundAmount Float?
  refundMethod String?
  notes        String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  customer     Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  order        Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  shop         Shop         @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([orderId])
  @@index([customerId])
  @@map("returns")
}

model Bundle {
  id           String          @id @default(cuid())
  shopId       String
  name         String
  description  String?
  price        Float
  comparePrice Float?
  image        String?
  isActive     Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  products     BundleProduct[]
  shop         Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@map("bundles")
}

model BundleProduct {
  id        String  @id @default(cuid())
  bundleId  String
  productId String
  quantity  Int     @default(1)
  position  Int     @default(0)
  bundle    Bundle  @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id])

  @@unique([bundleId, productId])
  @@map("bundle_products")
}

model Page {
  id               String   @id @default(cuid())
  shopId           String
  title            String
  slug             String
  content          String?
  seoTitle         String?
  seoDescription   String?
  isPublished      Boolean  @default(false)
  showInMenu       Boolean  @default(false)
  menuPosition     Int?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  selectedProducts Json?
  template         String?  @default("STANDARD")
  displayType      String?  @default("GRID")
  couponCode       String?
  featuredImage    String?
  shop             Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, slug])
  @@index([shopId])
  @@map("pages")
}

model Navigation {
  id        String   @id @default(cuid())
  shopId    String
  name      String
  location  String
  items     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, location])
  @@index([shopId])
  @@map("navigations")
}

model Blog {
  id               String             @id @default(cuid())
  shopId           String
  title            String
  slug             String
  description      String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  BlogPostCategory BlogPostCategory[]
  posts            BlogPost[]
  shop             Shop               @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@unique([shopId, slug])
  @@index([shopId])
  @@map("blogs")
}

model BlogPost {
  id             String                     @id @default(cuid())
  blogId         String
  title          String
  slug           String
  content        String?
  excerpt        String?
  featuredImage  String?
  authorId       String?
  isPublished    Boolean                    @default(false)
  publishedAt    DateTime?
  seoTitle       String?
  seoDescription String?
  allowComments  Boolean                    @default(true)
  createdAt      DateTime                   @default(now())
  updatedAt      DateTime                   @updatedAt
  comments       BlogComment[]
  categories     BlogPostCategoryRelation[]
  tags           BlogPostTag[]
  author         User?                      @relation(fields: [authorId], references: [id])
  blog           Blog                       @relation(fields: [blogId], references: [id], onDelete: Cascade)

  @@unique([blogId, slug])
  @@index([isPublished])
  @@index([publishedAt])
  @@map("blog_posts")
}

model BlogPostCategory {
  id          String                     @id @default(cuid())
  blogId      String
  name        String
  slug        String
  description String?
  createdAt   DateTime                   @default(now())
  updatedAt   DateTime                   @updatedAt
  blog        Blog                       @relation(fields: [blogId], references: [id], onDelete: Cascade)
  posts       BlogPostCategoryRelation[]

  @@unique([blogId, slug])
  @@map("blog_post_categories")
}

model BlogPostCategoryRelation {
  id         String           @id @default(cuid())
  postId     String
  categoryId String
  category   BlogPostCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  post       BlogPost         @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, categoryId])
  @@map("blog_post_category_relations")
}

model BlogPostTag {
  id     String   @id @default(cuid())
  postId String
  name   String
  post   BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, name])
  @@map("blog_post_tags")
}

model BlogComment {
  id          String        @id @default(cuid())
  postId      String
  customerId  String?
  authorName  String
  authorEmail String
  content     String
  isApproved  Boolean       @default(false)
  parentId    String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  customer    Customer?     @relation(fields: [customerId], references: [id])
  parent      BlogComment?  @relation("CommentParent", fields: [parentId], references: [id])
  children    BlogComment[] @relation("CommentParent")
  post        BlogPost      @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([isApproved])
  @@map("blog_comments")
}

model Webhook {
  id              String       @id @default(cuid())
  shopId          String
  url             String
  events          String[]
  secret          String
  isActive        Boolean      @default(true)
  lastTriggeredAt DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  logs            WebhookLog[]
  shop            Shop         @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@map("webhooks")
}

model WebhookLog {
  id           String   @id @default(cuid())
  payload      Json
  durationMs   Int?
  createdAt    DateTime @default(now())
  error        String?
  eventType    String
  responseBody Json?
  responseCode Int?
  webhookId    String
  webhook      Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([createdAt])
  @@map("webhook_logs")
}

model ShopEvent {
  id         String   @id @default(cuid())
  shopId     String
  type       String
  entityType String?
  entityId   String?
  payload    Json
  userId     String?
  createdAt  DateTime @default(now())
  shop       Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([type])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("shop_events")
}

model Subscription {
  id                    String             @id @default(cuid())
  companyId             String             @unique
  plan                  SubscriptionPlan   @default(TRIAL)
  status                SubscriptionStatus @default(TRIAL)
  trialStartDate        DateTime           @default(now())
  trialEndDate          DateTime
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  nextBillingDate       DateTime?
  paymentMethod         String?
  paymentDetails        Json?
  lastPaymentDate       DateTime?
  lastPaymentAmount     Float?
  monthlyPrice          Float?
  transactionFee        Float?             @default(0.5)
  taxRate               Float?             @default(18)
  cancelledAt           DateTime?
  cancellationReason    String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  company               Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([status])
  @@index([trialEndDate])
  @@index([subscriptionEndDate])
  @@map("subscriptions")
}

model WishlistItem {
  id         String          @id @default(cuid())
  shopId     String
  customerId String
  productId  String
  variantId  String?
  createdAt  DateTime        @default(now())
  customer   Customer        @relation(fields: [customerId], references: [id], onDelete: Cascade)
  product    Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  shop       Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)
  variant    ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([customerId, productId, variantId])
  @@index([shopId])
  @@index([customerId])
  @@index([productId])
  @@map("wishlist_items")
}

model TrackingPixel {
  id          String   @id @default(cuid())
  shopId      String
  platform    String
  pixelId     String
  accessToken String?
  isActive    Boolean  @default(true)
  events      String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([platform])
  @@map("tracking_pixels")
}

model Automation {
  id          String          @id @default(cuid())
  name        String
  description String?
  isActive    Boolean         @default(true)
  trigger     Json
  conditions  Json?
  actions     Json
  createdBy   String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  shopId      String
  logs        AutomationLog[]
  shop        Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([isActive])
  @@map("automations")
}

model AutomationLog {
  id            String     @id @default(cuid())
  automationId  String
  status        String
  error         String?
  createdAt     DateTime   @default(now())
  actionResults Json?
  durationMs    Int?
  eventPayload  Json
  eventType     String
  automation    Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([automationId])
  @@index([status])
  @@index([createdAt])
  @@map("automation_logs")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  USER
  INFLUENCER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

enum IntegrationType {
  INVOICE4U
  STRIPE
  ZAPIER
  WHATSAPP
  GOOGLE_CALENDAR
  PAYPLUS
  PAYPAL
  FOCUS_SHIPPING
}

enum SubscriptionPlan {
  TRIAL
  BRANDING
  QUICK_SHOP
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  EXPIRED
  CANCELLED
}

enum ProductStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ProductAvailability {
  IN_STOCK
  OUT_OF_STOCK
  PRE_ORDER
  BACKORDER
  DISCONTINUED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  PAID
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIAL
  FULFILLED
}

enum CustomerTier {
  REGULAR
  VIP
  PREMIUM
}

enum DiscountType {
  PERCENTAGE
  FIXED
  BUY_X_GET_Y
  BUY_X_PAY_Y
  VOLUME_DISCOUNT
  NTH_ITEM_DISCOUNT
  FREE_GIFT
}

enum DiscountTarget {
  ALL_PRODUCTS
  SPECIFIC_PRODUCTS
  SPECIFIC_CATEGORIES
  SPECIFIC_COLLECTIONS
  EXCLUDE_PRODUCTS
  EXCLUDE_CATEGORIES
  EXCLUDE_COLLECTIONS
}

enum DiscountCustomerTarget {
  ALL_CUSTOMERS
  REGISTERED_CUSTOMERS
  SPECIFIC_CUSTOMERS
  CUSTOMER_TIERS
}

enum CollectionType {
  MANUAL
  AUTOMATIC
}

enum TransactionType {
  CHARGE
  REFUND
}

enum ReturnStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSING
  COMPLETED
  CANCELLED
}

enum GiftCondition {
  MIN_ORDER_AMOUNT
  SPECIFIC_PRODUCT
}

// ===== Custom Fields =====

model CustomFieldDefinition {
  id     String @id @default(cuid())
  shopId String
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  // Namespace support (e.g., "custom", "product", "shipping")
  namespace String          @default("custom")
  key       String // Unique key within namespace (e.g., "ingredients")
  label     String // Display label (e.g., "מרכיבים")
  type      CustomFieldType // Field type

  description String? // Help text
  required    Boolean @default(false)

  // Validation
  validations Json? // Type-specific validation rules

  // Scope: Global or per-category
  scope       CustomFieldScope @default(GLOBAL)
  categoryIds String[] // Empty = global, populated = specific categories

  // Display settings
  showInStorefront Boolean @default(false)
  position         Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  values CustomFieldValue[]

  @@unique([shopId, namespace, key])
  @@index([shopId])
  @@index([shopId, scope])
  @@map("custom_field_definitions")
}

model CustomFieldValue {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  definitionId String
  definition   CustomFieldDefinition @relation(fields: [definitionId], references: [id], onDelete: Cascade)

  value String? // JSON string for complex values

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, definitionId])
  @@index([productId])
  @@index([definitionId])
  @@map("custom_field_values")
}

enum CustomFieldType {
  TEXT
  RICH_TEXT
  DATE
  COLOR
  CHECKBOX
  NUMBER
  URL
  FILE
}

enum CustomFieldScope {
  GLOBAL // Available for all products
  CATEGORY // Available only for products in specific categories
}

// ===== OTP (One-Time Password) =====

model OtpToken {
  id        String   @id @default(cuid())
  shopId    String
  email     String
  code      String // קוד OTP (6 ספרות)
  expiresAt DateTime
  used      Boolean  @default(false)
  attempts  Int      @default(0) // מספר ניסיונות אימות
  createdAt DateTime @default(now())
  shop      Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([email])
  @@index([code])
  @@index([expiresAt])
  @@map("otp_tokens")
}

// ===== Product Add-ons =====

model ProductAddon {
  id     String @id @default(cuid())
  shopId String
  shop   Shop   @relation(fields: [shopId], references: [id], onDelete: Cascade)

  name     String // שם התוספת (לדוגמה: "רקמה", "אריזת מתנה")
  type     ProductAddonType // סוג התוספת
  required Boolean          @default(false) // האם חובה לבחור

  // Scope: Global or per-product/category
  scope       ProductAddonScope @default(GLOBAL)
  productIds  String[] // רשימת מוצרים (אם scope = PRODUCT)
  categoryIds String[] // רשימת קטגוריות (אם scope = CATEGORY)

  // Display settings
  position Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  values ProductAddonValue[]

  @@index([shopId])
  @@index([shopId, scope])
  @@map("product_addons")
}

model ProductAddonValue {
  id      String       @id @default(cuid())
  addonId String
  addon   ProductAddon @relation(fields: [addonId], references: [id], onDelete: Cascade)

  label    String // תווית (לדוגמה: "רקמה שם", "קופסת מתנה גדולה")
  price    Float // מחיר התוספת
  position Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([addonId])
  @@map("product_addon_values")
}

enum ProductAddonType {
  SINGLE_CHOICE // בחירה אחת מרשימה (radio buttons)
  MULTIPLE_CHOICE // בחירה מרובה (checkboxes)
  TEXT_INPUT // קלט טקסט חופשי (לדוגמה: טקסט לרקמה)
  CHECKBOX // תיבת סימון בודדת (כן/לא)
}

enum ProductAddonScope {
  GLOBAL // זמין לכל המוצרים
  PRODUCT // זמין למוצרים ספציפיים
  CATEGORY // זמין לקטגוריות ספציפיות
}

// ===== Plugins Marketplace =====

model Plugin {
  id        String  @id @default(cuid())
  shopId    String? // null = גלובלי, לא null = ספציפי לחנות
  companyId String? // null = גלובלי, לא null = ספציפי לחברה

  // מידע בסיסי
  name        String
  slug        String  @unique
  description String?
  icon        String? // URL לאייקון
  version     String  @default("1.0.0")
  author      String?

  // סוג התוסף
  type     PluginType // CORE או SCRIPT
  category PluginCategory // ANALYTICS, MARKETING, PAYMENT, etc.

  // הגדרות הפעלה
  isActive    Boolean @default(false)
  isInstalled Boolean @default(false)
  isBuiltIn   Boolean @default(false) // תוספים מובנים (לא ניתן להסיר)

  // הגדרות תוסף סקריפט
  scriptUrl      String? // URL לסקריפט (רק ל-SCRIPT plugins)
  scriptContent  String? // תוכן סקריפט ישיר (רק ל-SCRIPT plugins)
  injectLocation ScriptLocation? // HEAD, BODY_START, BODY_END

  // הגדרות תוסף ליבה
  configSchema Json? // Schema להגדרות התוסף (Zod schema)
  config       Json? // הגדרות התוסף הספציפיות

  // Metadata
  metadata     Json? // מידע נוסף (תמונות, מסכים, וכו')
  requirements Json? // דרישות (מינימום גרסה, תוספים אחרים, וכו')

  // תמחור
  isFree   Boolean @default(true) // האם התוסף חינמי
  price    Float? // מחיר חודשי (אם לא חינמי)
  currency String  @default("ILS")

  // ניהול על ידי סופר אדמין
  isEditable   Boolean @default(true) // האם ניתן לערוך (סופר אדמין)
  isDeletable  Boolean @default(false) // האם ניתן למחוק (רק תוספים לא מובנים)
  adminNotes   String? // הערות לסופר אדמין
  displayOrder Int     @default(0) // סדר תצוגה במרקטפלייס

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  installedAt DateTime?

  shop          Shop?                @relation(fields: [shopId], references: [id], onDelete: Cascade)
  company       Company?             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  subscriptions PluginSubscription[]

  @@index([shopId])
  @@index([companyId])
  @@index([type])
  @@index([isActive])
  @@index([slug])
  @@index([isFree])
  @@map("plugins")
}

enum PluginType {
  CORE // תוסף ליבה - משולב בקוד
  SCRIPT // תוסף סקריפט - הזרקה בלבד
}

enum PluginCategory {
  ANALYTICS // אנליטיקס (Google Analytics)
  MARKETING // שיווק (Shop the Look)
  PAYMENT // תשלום (Cash on Delivery)
  INVENTORY // מלאי (Bundle Products)
  COMMUNICATION // תקשורת (WhatsApp)
  OPERATIONS // פעולות (POS, Saturday Shutdown)
  CUSTOMIZATION // התאמה אישית
}

enum ScriptLocation {
  HEAD // <head>
  BODY_START // תחילת <body>
  BODY_END // סוף <body>
}

// ===== Plugin Subscriptions (מנויים לתוספים) =====

model PluginSubscription {
  id        String @id @default(cuid())
  companyId String
  pluginId  String

  // סטטוס
  status   PluginSubscriptionStatus @default(PENDING)
  isActive Boolean                  @default(false)

  // תאריכים
  startDate       DateTime?
  endDate         DateTime?
  nextBillingDate DateTime?

  // תשלום
  paymentMethod       String? // PayPlus
  paymentDetails      Json? // פרטי תשלום PayPlus
  recurringPaymentUid String? // UID של הוראת הקבע ב-PayPlus
  cardToken           String? // Token לכרטיס אשראי

  // מחיר
  monthlyPrice      Float
  lastPaymentDate   DateTime?
  lastPaymentAmount Float?

  // ביטול
  cancelledAt        DateTime?
  cancellationReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  plugin  Plugin  @relation(fields: [pluginId], references: [id], onDelete: Cascade)

  @@unique([companyId, pluginId])
  @@index([companyId])
  @@index([pluginId])
  @@index([status])
  @@index([nextBillingDate])
  @@map("plugin_subscriptions")
}

enum PluginSubscriptionStatus {
  PENDING // ממתין לתשלום
  ACTIVE // פעיל
  CANCELLED // בוטל
  EXPIRED // פג תוקף
  FAILED // תשלום נכשל
}

model ProductPageTemplate {
  id            String    @id @default(cuid())
  shopId        String
  name          String // שם התבנית
  elements      Json // אלמנטי התבנית (ProductPageElement[])
  productIds    String[]  @default([]) // מוצרים ספציפיים שמשתמשים בתבנית זו
  categoryIds   String[]  @default([]) // קטגוריות שמשתמשות בתבנית זו
  collectionIds String[]  @default([]) // collections שמשתמשות בתבנית זו
  isDefault     Boolean   @default(false) // האם זו תבנית ברירת מחדל לחנות
  isActive      Boolean   @default(true) // האם התבנית פעילה
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  shop          Shop      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  products      Product[] // מוצרים שמשתמשים בתבנית זו

  @@index([shopId])
  @@index([isDefault])
  @@index([isActive])
  @@map("product_page_templates")
}

// ===== Waitlist (רשימת המתנה) =====

model Waitlist {
  id         String          @id @default(cuid())
  shopId     String
  productId  String
  variantId  String? // אם זה וריאציה ספציפית
  email      String
  customerId String? // אם הלקוח רשום במערכת
  notifiedAt DateTime? // מתי נשלח המייל שהמוצר חזר למלאי
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  shop       Shop            @relation(fields: [shopId], references: [id], onDelete: Cascade)
  product    Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant    ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  customer   Customer?       @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@unique([shopId, productId, variantId, email]) // מניעת כפילויות
  @@index([shopId])
  @@index([productId])
  @@index([variantId])
  @@index([email])
  @@index([notifiedAt])
  @@map("waitlist")
}

// מודל אנשי קשר - מערכת מקיפה לניהול כל סוגי הקשרים
model Contact {
  id                    String                    @id @default(cuid())
  shopId                String
  email                 String
  firstName             String?
  lastName              String?
  phone                 String?
  company               String?
  notes                 String?
  tags                  String[]                  @default([])
  
  // אישור דיוור
  emailMarketingConsent Boolean                   @default(false)
  emailMarketingConsentAt DateTime?
  emailMarketingConsentSource String? // איפה נתן את האישור: checkout, newsletter, contact_form, manual
  
  // קישור ללקוח אם יש רכישה
  customerId            String?                   @unique
  
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  
  shop                  Shop                      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  customer              Customer?                 @relation(fields: [customerId], references: [id], onDelete: SetNull)
  categoryAssignments   ContactCategoryAssignment[]
  
  @@unique([shopId, email])
  @@index([shopId])
  @@index([email])
  @@index([customerId])
  @@index([emailMarketingConsent])
  @@map("contacts")
}

// קטגוריות אנשי קשר
model ContactCategory {
  id          String                    @id @default(cuid())
  shopId      String
  type        ContactCategoryType
  name        String                    // שם בעברית להצגה
  description String?
  color       String?                   // צבע להצגה ב-UI
  isActive    Boolean                   @default(true)
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime                  @updatedAt
  
  shop        Shop                      @relation(fields: [shopId], references: [id], onDelete: Cascade)
  assignments ContactCategoryAssignment[]
  
  @@unique([shopId, type])
  @@index([shopId])
  @@index([type])
  @@map("contact_categories")
}

// יחס many-to-many בין אנשי קשר לקטגוריות
model ContactCategoryAssignment {
  id         String            @id @default(cuid())
  contactId  String
  categoryId String
  createdAt  DateTime          @default(now())
  metadata   Json?             // מידע נוסף: מתי נוצר, איך נוצר, וכו'
  
  contact   Contact           @relation(fields: [contactId], references: [id], onDelete: Cascade)
  category  ContactCategory   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@unique([contactId, categoryId])
  @@index([contactId])
  @@index([categoryId])
  @@map("contact_category_assignments")
}

enum ContactCategoryType {
  CUSTOMER      // לקוחות - שרכשו באתר
  CLUB_MEMBER   // חברי מועדון - נרשמו לאתר
  NEWSLETTER    // ניוזלטר - נרשמו לטופס ניוזלטר
  CONTACT_FORM  // יצירת קשר - השאירו הודעה בטופס יצירת קשר
}

model Popup {
  id               String   @id @default(cuid())
  shopId           String
  name             String
  layout           String   @default("one-column") // one-column, two-column
  borderRadius     Int      @default(0) // עיגול פינות בפיקסלים
  isActive         Boolean  @default(true)
  content          Json // תוכן הפופאפ (טקסט, תמונות, טפסים)
  displayFrequency String   @default("every-visit") // every-visit, once-daily, once-weekly, once-monthly
  displayLocation  String   @default("all-pages") // all-pages, specific-pages
  specificPages    Json? // רשימת עמודים ספציפיים אם displayLocation = specific-pages
  delay            Int?     @default(0) // עיכוב בהצגה בשניות
  trigger          String   @default("on-load") // on-load, on-exit-intent, on-scroll
  scrollPercentage Int? // אחוז גלילה להצגה (אם trigger = on-scroll)
  backgroundColor  String?  @default("#ffffff")
  textColor        String?  @default("#000000")
  overlayColor     String?  @default("#000000")
  overlayOpacity   Float?   @default(0.5)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  shop             Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([isActive])
  @@map("popups")
}

model TrafficSource {
  id           String   @id @default(cuid())
  shopId       String
  name         String
  uniqueId     String
  medium       String?  // e.g., "email", "social", "cpc", "organic"
  campaign     String?  // שם הקמפיין
  referralLink String?  // קישור הפניה (אם רלוונטי)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  shop         Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  orders       Order[]

  @@unique([shopId, uniqueId])
  @@index([shopId])
  @@index([uniqueId])
  @@index([isActive])
  @@map("traffic_sources")
}
