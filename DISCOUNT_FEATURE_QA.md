# בדיקות QA - פיצ'ר הנחות אוטומטיות למוצר

## ✅ בדיקות שבוצעו ותוקנו:

### 1. Priority (עדיפות)
- ✅ **תקין**: ההנחות מסודרות לפי priority (מ-10 ל-0)
- ✅ **תקין**: ההנחה עם priority גבוה יותר תוחל קודם

### 2. canCombine (שילוב הנחות)
- ✅ **תקין**: אם הנחה עם `canCombine: false` ויש הנחות קודמות שהוחלו, היא לא תוחל
- ✅ **תקין**: אם הנחה עם `canCombine: false` ואין הנחות קודמות, היא תוחל
- ✅ **תקין**: אם הנחה עם `canCombine: true`, היא תוחל גם אם יש הנחות קודמות

### 3. customerTarget (קהל יעד)
- ✅ **תקין**: `ALL_CUSTOMERS` - חל על כולם
- ✅ **תקין**: `REGISTERED_CUSTOMERS` - חל רק על לקוחות מחוברים
- ✅ **תקין**: `SPECIFIC_CUSTOMERS` - חל רק על לקוחות ספציפיים
- ✅ **תקין**: `CUSTOMER_TIERS` - חל רק על רמות לקוח ספציפיות

### 4. productMatch (התאמת מוצר)
- ✅ **תקין**: `ALL_PRODUCTS` - חל על כל המוצרים
- ✅ **תקין**: `SPECIFIC_PRODUCTS` - חל רק על מוצרים ספציפיים
- ✅ **תקין**: `SPECIFIC_CATEGORIES` - חל רק על קטגוריות ספציפיות
- ✅ **תקין**: `SPECIFIC_COLLECTIONS` - חל רק על קטגוריות ספציפיות
- ✅ **תקין**: `EXCLUDE_PRODUCTS` - חל על כל המוצרים חוץ ממוצרים ספציפיים
- ✅ **תקין**: `EXCLUDE_CATEGORIES` - חל על כל המוצרים חוץ מקטגוריות ספציפיות
- ✅ **תקין**: `EXCLUDE_COLLECTIONS` - חל על כל המוצרים חוץ מקטגוריות ספציפיות

### 5. חישוב מחירים
- ✅ **תקין**: המחיר המקורי הוא תמיד `basePrice` (לא המחיר אחרי ההנחה הראשונה)
- ✅ **תקין**: המחיר המוזל הוא המחיר אחרי כל ההנחות
- ✅ **תקין**: אם יש כמה הנחות, כל הנחה מחושבת על המחיר אחרי ההנחה הקודמת
- ✅ **תקין**: `maxDiscount` מוגבל נכון

### 6. הצגת הנחות
- ✅ **תקין**: אם יש `comparePrice` (קו מחוק), מוצג "הנחה נוספת:"
- ✅ **תקין**: אם אין `comparePrice`, מוצג רק "הנחה:"
- ✅ **תקין**: כל ההנחות הפעילות מוצגות יחד
- ✅ **תקין**: המחיר המוזל מוצג נכון

### 7. קריאות כפולות
- ✅ **תקין**: יש debounce של 150ms כדי למנוע קריאות כפולות
- ✅ **תקין**: הקריאה מתבטלת אם ה-useEffect מתעדכן לפני שהקריאה מסתיימת

### 8. סוגי הנחות
- ✅ **תקין**: `PERCENTAGE` - מחושב נכון
- ✅ **תקין**: `FIXED` - מחושב נכון
- ⚠️ **לא רלוונטי**: `BUY_X_GET_Y`, `FREE_GIFT`, `NTH_ITEM_DISCOUNT`, `VOLUME_DISCOUNT` - אלה הנחות לעגלה, לא למוצר בודד

### 9. תאריכים
- ✅ **תקין**: `startDate` - ההנחה לא תוחל לפני התאריך
- ✅ **תקין**: `endDate` - ההנחה לא תוחל אחרי התאריך
- ✅ **תקין**: אם `startDate` או `endDate` הם null, ההנחה תמיד פעילה

### 10. סטטוס הנחה
- ✅ **תקין**: רק הנחות עם `isActive: true` נבדקות
- ✅ **תקין**: רק הנחות עם `isAutomatic: true` נבדקות

## 🔍 מקרי בדיקה נוספים לבדיקה ידנית:

### מקרה 1: שתי הנחות עם canCombine: true
- הנחה 1: 5%, priority 10, canCombine: true
- הנחה 2: 30%, priority 0, canCombine: true
- **צפוי**: שתי ההנחות יוחלו ויוצגו
- **מחיר**: basePrice → אחרי 5% → אחרי 30%

### מקרה 2: שתי הנחות עם canCombine: false
- הנחה 1: 5%, priority 10, canCombine: true
- הנחה 2: 30%, priority 0, canCombine: false
- **צפוי**: רק ההנחה הראשונה תוחל ותוצג
- **מחיר**: basePrice → אחרי 5%

### מקרה 3: הנחה עם canCombine: false ללא הנחות קודמות
- הנחה 1: 30%, priority 0, canCombine: false
- **צפוי**: ההנחה תוחל ותוצג
- **מחיר**: basePrice → אחרי 30%

### מקרה 4: לקוח לא מחובר
- הנחה: 5%, customerTarget: REGISTERED_CUSTOMERS
- **צפוי**: ההנחה לא תוחל

### מקרה 5: לקוח מחובר
- הנחה: 5%, customerTarget: REGISTERED_CUSTOMERS
- **צפוי**: ההנחה תוחל

### מקרה 6: מוצר עם comparePrice
- **צפוי**: מוצג "הנחה נוספת:"

### מקרה 7: מוצר בלי comparePrice
- **צפוי**: מוצג רק "הנחה:"

### מקרה 8: variant שונה
- **צפוי**: המחיר מחושב לפי ה-variant שנבחר

### מקרה 9: addons
- **צפוי**: המחיר כולל את ה-addons

## 🐛 בעיות שזוהו ותוקנו:

1. ✅ **תוקן**: כל הנחה שמרה את `basePrice` כ-`originalPrice`, גם אם יש הנחות קודמות
2. ✅ **תוקן**: ב-ProductElements, המחיר המקורי היה המחיר אחרי ההנחה הראשונה במקום basePrice
3. ✅ **תוקן**: קריאות כפולות ל-API
4. ✅ **תוקן**: הטקסט "הנחה נוספת" הוצג גם כשאין comparePrice

## 📝 הערות:

- `minOrderAmount` לא נבדק במוצר בודד (זה בסדר, זה לסכום הזמנה)
- הנחות מסוג `BUY_X_GET_Y`, `FREE_GIFT` וכו' לא מוצגות במוצר בודד (זה בסדר, אלה הנחות לעגלה)

